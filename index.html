<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P√°tio Pro Elite - IA Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --main-color: #2563eb; }
        body { -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-button.active { color: var(--main-color); background: #eff6ff; border-radius: 12px; }
        #modal-os { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 100%; max-width: 450px; border-radius: 30px; padding: 25px; max-height: 90vh; overflow-y: auto; }
        .os-print { font-family: 'Courier New', Courier, monospace; border: 2px solid #000; padding: 20px; color: black; line-height: 1.2; }
        .atrasado { border: 2px solid #ef4444 !important; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-32 text-gray-800 font-sans">

    <div id="modal-os" onclick="this.style.display='none'">
        <div class="modal-content os-print" onclick="event.stopPropagation()">
            <div id="conteudo-os"></div>
            <button onclick="window.print()" class="mt-4 w-full bg-black text-white py-3 rounded-xl font-bold uppercase no-print">Imprimir / PDF</button>
        </div>
    </div>

    <header id="header-main" class="bg-blue-700 text-white p-5 shadow-lg sticky top-0 z-50 rounded-b-2xl" style="background-color: var(--main-color);">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-black italic uppercase">P√ÅTIO PRO ELITE</h1>
            <span id="contador" class="bg-black/20 px-3 py-1 rounded-full text-[10px] font-bold uppercase">0 VE√çCULOS</span>
        </div>
    </header>

    <main class="p-4 max-w-xl mx-auto space-y-4">
        
        <section id="aba-entrada" class="tab-content active">
            <div class="bg-white p-6 rounded-3xl shadow-md border">
                <form id="form-entrada" class="space-y-4">
                    <h3 class="font-black text-[10px] uppercase text-blue-600">Ve√≠culo e Cliente</h3>
                    <input type="text" id="placa" placeholder="PLACA" required class="w-full bg-gray-50 border-2 p-4 rounded-2xl font-black text-xl text-center uppercase">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="modelo" placeholder="MODELO" required class="w-full bg-gray-50 border-2 p-3 rounded-xl font-bold uppercase">
                        <input type="text" id="cor-veiculo" placeholder="COR" required class="w-full bg-gray-50 border-2 p-3 rounded-xl font-bold uppercase">
                    </div>
                    <input type="text" id="cliente" placeholder="NOME DO CLIENTE" required class="w-full bg-gray-50 border-2 p-3 rounded-xl font-bold uppercase">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="cpf-cliente" placeholder="CPF" required class="w-full bg-gray-50 border-2 p-3 rounded-xl font-bold">
                        <input type="date" id="data-prevista" required class="w-full bg-gray-50 border-2 p-3 rounded-xl font-bold">
                    </div>

                    <h3 class="font-black text-[10px] uppercase text-green-600 mt-4">Or√ßamento de Servi√ßos</h3>
                    <div id="lista-servicos-entrada" class="space-y-2">
                        <div class="grid grid-cols-3 gap-2">
                            <input type="text" placeholder="Servi√ßo" class="col-span-2 bg-gray-50 border p-2 rounded-lg text-xs s-nome">
                            <input type="number" placeholder="R$" class="bg-gray-50 border p-2 rounded-lg text-xs s-preco" oninput="somarOrcamento()">
                        </div>
                    </div>
                    <button type="button" onclick="maisServico()" class="text-[10px] font-bold text-blue-500 uppercase">+ Adicionar Linha</button>
                    
                    <div class="bg-green-50 p-4 rounded-2xl text-center">
                        <span class="text-[10px] font-bold uppercase block text-green-600">Total Previsto</span>
                        <span id="total-estimado" class="text-xl font-black text-green-700">R$ 0,00</span>
                    </div>

                    <div id="container-previa" class="hidden w-full h-40 rounded-2xl overflow-hidden border-2 mb-4"><img id="img-previa" class="w-full h-full object-cover"></div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex flex-col items-center justify-center border-2 border-gray-200 p-4 rounded-2xl text-gray-600 bg-gray-50 cursor-pointer">
                            <span class="font-bold text-[10px] uppercase">üì∏ Foto</span>
                            <input type="file" accept="image/*" capture="environment" class="hidden" onchange="processarFoto(this, 'entrada')">
                        </label>
                        <button type="submit" class="bg-blue-600 text-white font-black p-5 rounded-2xl shadow-lg uppercase" style="background-color: var(--main-color);">Registrar</button>
                    </div>
                </form>
            </div>
        </section>

        <section id="aba-patio" class="tab-content">
            <div id="lista-veiculos" class="space-y-6"></div>
        </section>

        <section id="aba-estoque" class="tab-content">
            <div id="lista-estoque" class="space-y-2"></div>
        </section>

        <section id="aba-relatorio" class="tab-content">
            <div id="lista-relatorio" class="space-y-3"></div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around items-center h-24 z-50 shadow-2xl">
        <button onclick="mudarAba('entrada')" class="nav-button active flex flex-col items-center flex-1"><span class="text-xl">‚ûï</span><span class="text-[7px] font-bold uppercase">Entrada</span></button>
        <button onclick="mudarAba('patio')" class="nav-button flex flex-col items-center flex-1"><span class="text-xl">üöó</span><span class="text-[7px] font-bold uppercase">P√°tio</span></button>
        <button onclick="mudarAba('estoque')" class="nav-button flex flex-col items-center flex-1"><span class="text-xl">üì¶</span><span class="text-[7px] font-bold uppercase">Estoque</span></button>
        <button onclick="mudarAba('relatorio')" class="nav-button flex flex-col items-center flex-1"><span class="text-xl">üìã</span><span class="text-[7px] font-bold uppercase">Relat.</span></button>
    </nav>

    <script>
        let patio = JSON.parse(localStorage.getItem('patio_data')) || [];
        let historico = JSON.parse(localStorage.getItem('patio_historico')) || [];
        let tempFotoEntrada = null;

        function maisServico() {
            const div = document.createElement('div');
            div.className = "grid grid-cols-3 gap-2";
            div.innerHTML = `<input type="text" placeholder="Servi√ßo" class="col-span-2 bg-gray-50 border p-2 rounded-lg text-xs s-nome">
                             <input type="number" placeholder="R$" class="bg-gray-50 border p-2 rounded-lg text-xs s-preco" oninput="somarOrcamento()">`;
            document.getElementById('lista-servicos-entrada').appendChild(div);
        }

        function somarOrcamento() {
            let total = 0;
            document.querySelectorAll('.s-preco').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            document.getElementById('total-estimado').innerText = `R$ ${total.toFixed(2)}`;
            return total;
        }

        function processarFoto(input, tipo, id = null) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const b64 = e.target.result;
                    if(tipo === 'entrada') {
                        tempFotoEntrada = b64;
                        document.getElementById('img-previa').src = b64;
                        document.getElementById('container-previa').classList.remove('hidden');
                    } else {
                        const v = patio.find(v => v.id === id);
                        v.fotoDepois = b64;
                        localStorage.setItem('patio_data', JSON.stringify(patio));
                        renderizar();
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        document.getElementById('form-entrada').addEventListener('submit', (e) => {
            e.preventDefault();
            let servicosArray = [];
            document.querySelectorAll('#lista-servicos-entrada .grid').forEach(row => {
                let n = row.querySelector('.s-nome').value;
                let p = row.querySelector('.s-preco').value;
                if(n) servicosArray.push({nome: n, preco: p});
            });

            patio.unshift({
                id: Date.now(),
                placa: document.getElementById('placa').value.toUpperCase(),
                modelo: document.getElementById('modelo').value.toUpperCase(),
                cor: document.getElementById('cor-veiculo').value.toUpperCase(),
                cliente: document.getElementById('cliente').value.toUpperCase(),
                cpf: document.getElementById('cpf-cliente').value,
                dataPrevista: document.getElementById('data-prevista').value,
                fotoAntes: tempFotoEntrada,
                fotoDepois: null,
                status: "PENDENTE",
                servicos: servicosArray,
                total: somarOrcamento()
            });
            localStorage.setItem('patio_data', JSON.stringify(patio));
            location.reload();
        });

        function renderizar() {
            const listaPatio = document.getElementById('lista-veiculos');
            listaPatio.innerHTML = '';
            const hoje = new Date().toISOString().split('T')[0];

            patio.forEach(v => {
                const isAtrasado = v.dataPrevista < hoje && v.status !== "FINALIZADO";
                listaPatio.innerHTML += `
                    <div class="bg-white p-5 rounded-3xl shadow-lg border-2 ${isAtrasado ? 'atrasado' : 'border-blue-50'} space-y-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="font-black text-2xl text-blue-700 uppercase">${v.placa}</span>
                                ${isAtrasado ? '<span class="block text-[8px] font-bold text-red-500 uppercase">‚ö†Ô∏è SERVI√áO ATRASADO</span>' : ''}
                            </div>
                            <select onchange="atualizarCampo(${v.id}, 'status', this.value)" class="text-[9px] font-bold p-1 rounded bg-gray-100 outline-none">
                                <option value="PENDENTE" ${v.status==='PENDENTE'?'selected':''}>PENDENTE</option>
                                <option value="EM ANDAMENTO" ${v.status==='EM ANDAMENTO'?'selected':''}>EM ANDAMENTO</option>
                                <option value="FINALIZADO" ${v.status==='FINALIZADO'?'selected':''}>FINALIZADO</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <img src="${v.fotoAntes}" class="w-full h-24 object-cover rounded-xl bg-gray-100">
                            <label class="h-24 rounded-xl border-2 border-dashed border-gray-200 flex items-center justify-center cursor-pointer overflow-hidden">
                                ${v.fotoDepois ? `<img src="${v.fotoDepois}" class="w-full h-full object-cover">` : '<span class="text-[8px] font-bold">+ FOTO SA√çDA</span>'}
                                <input type="file" accept="image/*" capture="environment" class="hidden" onchange="processarFoto(this, 'depois', ${v.id})">
                            </label>
                        </div>

                        <div class="space-y-1">
                            <span class="text-[9px] font-bold text-gray-400 uppercase">Previs√£o: ${v.dataPrevista.split('-').reverse().join('/')}</span>
                            <div class="bg-gray-50 p-3 rounded-xl">
                                ${v.servicos.map(s => `<div class="flex justify-between text-[10px] font-bold"><span>${s.nome}</span><span>R$ ${parseFloat(s.preco).toFixed(2)}</span></div>`).join('')}
                                <div class="border-t mt-2 pt-1 flex justify-between font-black text-blue-600 text-xs"><span>TOTAL</span><span>R$ ${v.total.toFixed(2)}</span></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="gerarOS(${v.id})" class="bg-black text-white py-3 rounded-xl font-bold text-[10px] uppercase">VER O.S</button>
                            <button onclick="darSaida(${v.id})" class="bg-green-600 text-white py-3 rounded-xl font-bold text-[10px] uppercase">FINALIZAR</button>
                        </div>
                    </div>`;
            });
        }

        function atualizarCampo(id, campo, valor) {
            const v = patio.find(v => v.id === id);
            v[campo] = valor;
            localStorage.setItem('patio_data', JSON.stringify(patio));
            if(campo === 'status') renderizar();
        }

        function gerarOS(id) {
            const v = patio.find(v => v.id === id);
            let servs = v.servicos.map(s => `<div style="display:flex; justify-between; font-size:10px"><span>${s.nome}</span> <span>R$ ${parseFloat(s.preco).toFixed(2)}</span></div>`).join('');
            document.getElementById('conteudo-os').innerHTML = `
                <center><strong>ORDEM DE SERVI√áO</strong></center>
                <hr style="border:1px dashed #000; margin:10px 0">
                <p><strong>CLIENTE:</strong> ${v.cliente} | <strong>CPF:</strong> ${v.cpf}</p>
                <p><strong>VE√çCULO:</strong> ${v.modelo} (${v.placa})</p>
                <p><strong>PREVIS√ÉO:</strong> ${v.dataPrevista.split('-').reverse().join('/')}</p>
                <hr style="border:1px dashed #000; margin:10px 0">
                ${servs}
                <hr style="border:1px dashed #000; margin:10px 0">
                <p align="right"><strong>TOTAL GERAL: R$ ${v.total.toFixed(2)}</strong></p>
                <br><br><p align="center">_________________________<br>Assinatura</p>
            `;
            document.getElementById('modal-os').style.display = 'flex';
        }

        function darSaida(id) {
            const v = patio.find(v => v.id === id);
            historico.unshift({...v, saidaReal: new Date().toLocaleDateString()});
            localStorage.setItem('patio_historico', JSON.stringify(historico));
            patio = patio.filter(v => v.id !== id);
            localStorage.setItem('patio_data', JSON.stringify(patio));
            renderizar();
        }

        function mudarAba(aba) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            document.getElementById('aba-' + aba).classList.add('active');
            renderizar();
        }

        renderizar();
    </script>
</body>
</html>

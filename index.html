<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P√°tio Pro Elite - IA Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-button.active { color: #2563eb; background: #eff6ff; border-radius: 15px; }
        #bloqueio, #modal-saida, #pagina-detalhes { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        #pagina-detalhes { background: #f3f4f6; flex-direction: column; justify-content: flex-start; overflow-y: auto; padding: 0; }
        .modal-content { background: white; width: 100%; max-width: 400px; border-radius: 30px; padding: 25px; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-24 text-gray-800 font-sans">

    <div id="bloqueio">
        <div class="modal-content text-center">
            <h2 class="text-xl font-bold mb-4 uppercase text-blue-700">Ativa√ß√£o Requerida</h2>
            <p class="text-[10px] text-gray-400 font-bold uppercase mb-4">Insira a senha de acesso</p>
            <input type="password" id="senha-licenca" placeholder="Senha 0907" class="border-2 p-4 rounded-xl w-full mb-4 text-center outline-none focus:border-blue-600">
            <button onclick="verificarSenha()" class="bg-blue-600 text-white w-full py-4 rounded-xl font-bold uppercase shadow-lg">Ativar App</button>
        </div>
    </div>

    <div id="modal-saida">
        <div class="modal-content">
            <h3 class="font-black text-blue-700 uppercase italic mb-4">Finalizar e Enviar para IA</h3>
            <input type="hidden" id="saida-id-temp">
            
            <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Data de Sa√≠da</label>
            <input type="text" id="input-data-saida" class="w-full bg-gray-50 border-2 border-gray-100 p-4 rounded-2xl mb-4 text-center font-bold outline-none">
            
            <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Servi√ßo Realizado</label>
            <input type="text" id="input-servico-final" placeholder="Ex: Troca de Oleo e Filtro" class="w-full bg-gray-50 border-2 border-gray-100 p-4 rounded-2xl mb-6 font-bold uppercase outline-none focus:border-green-500">
            
            <div class="grid grid-cols-2 gap-3">
                <button onclick="fecharModalSaida()" class="bg-gray-100 text-gray-500 font-bold p-4 rounded-2xl uppercase text-[10px]">Cancelar</button>
                <button id="btn-confirmar-saida" onclick="confirmarSaidaFinal()" class="bg-green-600 text-white font-black p-4 rounded-2xl shadow-lg uppercase text-[10px]">Concluir Teste</button>
            </div>
        </div>
    </div>

    <div id="pagina-detalhes">
        <header class="bg-blue-700 text-white p-5 w-full flex items-center gap-4 shadow-lg">
            <button onclick="fecharDetalhes()" class="text-xl">‚Üê</button>
            <h1 class="text-lg font-black uppercase italic">Hist√≥rico de Servi√ßo</h1>
        </header>
        <div class="p-5 w-full max-w-xl space-y-4">
            <div class="w-full h-64 bg-gray-200 rounded-3xl overflow-hidden border-4 border-white shadow-md">
                <img id="detalhe-foto" class="w-full h-full object-cover">
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm space-y-3">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Placa</label><p id="detalhe-placa" class="font-black text-xl"></p></div>
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Cliente</label><p id="detalhe-cliente" class="font-bold"></p></div>
                </div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase">WhatsApp</label><p id="detalhe-telefone" class="font-bold text-blue-600"></p></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase">Modelo/Marca</label><p id="detalhe-modelo" class="font-bold uppercase"></p></div>
                <div class="grid grid-cols-2 gap-4 border-t pt-4">
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Entrada</label><p id="detalhe-entrada" class="font-bold text-gray-600"></p></div>
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Sa√≠da</label><p id="detalhe-saida" class="font-bold text-gray-600"></p></div>
                </div>
                <div class="border-t pt-4">
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Servi√ßo Executado</label>
                    <p id="detalhe-servico" class="font-bold text-green-600 italic uppercase"></p>
                </div>
            </div>
        </div>
    </div>

    <header class="bg-blue-700 text-white p-5 shadow-lg sticky top-0 z-50 rounded-b-2xl">
        <div class="flex justify-between items-center">
            <div>
                <h1 id="app-nome-display" class="text-xl font-black italic uppercase leading-none">P√ÅTIO PRO</h1>
                <span id="dias-restantes" class="text-[9px] font-bold opacity-70 uppercase">Verificando...</span>
            </div>
            <span id="contador" class="bg-blue-900 px-3 py-1 rounded-full text-[10px] font-bold uppercase italic">0 VE√çCULOS</span>
        </div>
    </header>

    <main class="p-4 max-w-xl mx-auto">
        <section id="aba-entrada" class="tab-content active">
            <div class="bg-white p-6 rounded-3xl shadow-md border border-gray-100">
                <form id="form-entrada" class="space-y-4">
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Data da Entrada</label>
                    <input type="text" id="input-data-entrada" required class="w-full bg-gray-50 border-2 border-gray-100 p-3 rounded-2xl text-center font-bold outline-none">
                    
                    <input type="text" id="placa" placeholder="PLACA" required class="w-full bg-gray-50 border-2 border-gray-100 p-4 rounded-2xl font-black text-xl text-center uppercase outline-none focus:border-blue-600">
                    <input type="text" id="modelo" placeholder="MODELO / MARCA" required class="w-full bg-gray-50 border-2 border-gray-100 p-4 rounded-2xl font-bold uppercase outline-none">
                    <input type="text" id="cliente" placeholder="NOME DO CLIENTE" required class="w-full bg-gray-50 border-2 border-gray-100 p-4 rounded-2xl font-bold uppercase outline-none">
                    <input type="tel" id="telefone" placeholder="WHATSAPP (DDD + N√öMERO)" required class="w-full bg-gray-50 border-2 border-gray-100 p-4 rounded-2xl font-bold outline-none">
                    
                    <div id="container-previa" class="hidden w-full h-40 rounded-2xl overflow-hidden border-2 border-blue-100">
                        <img id="img-previa" class="w-full h-full object-cover">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex flex-col items-center justify-center border-2 border-blue-200 p-4 rounded-2xl text-blue-600 cursor-pointer bg-blue-50">
                            <span class="font-bold text-[10px] uppercase">üì∏ Foto</span>
                            <input type="file" id="foto-camera" accept="image/*" capture="environment" class="hidden" onchange="mostrarPrevia(this)">
                        </label>
                        <button type="submit" class="bg-blue-600 text-white font-black p-5 rounded-2xl shadow-lg uppercase tracking-wider">Registrar</button>
                    </div>
                </form>
            </div>
        </section>

        <section id="aba-patio" class="tab-content">
            <div id="lista-veiculos" class="space-y-4"></div>
        </section>

        <section id="aba-relatorio" class="tab-content">
            <div id="lista-relatorio" class="space-y-3"></div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around items-center h-20 z-50">
        <button onclick="mudarAba('entrada')" id="btn-nav-entrada" class="nav-button active flex flex-col items-center flex-1 p-2">
            <span class="text-xl">‚ûï</span><span class="text-[8px] font-bold uppercase mt-1">Entrada</span>
        </button>
        <button onclick="mudarAba('patio')" id="btn-nav-patio" class="nav-button flex flex-col items-center flex-1 p-2">
            <span class="text-xl">üöó</span><span class="text-[8px] font-bold uppercase mt-1">P√°tio</span>
        </button>
        <button onclick="mudarAba('relatorio')" id="btn-nav-relatorio" class="nav-button flex flex-col items-center flex-1 p-2">
            <span class="text-xl">üìã</span><span class="text-[8px] font-bold uppercase mt-1">Relat√≥rio</span>
        </button>
    </nav>

    <script>
        let patio = JSON.parse(localStorage.getItem('patio_data')) || [];
        let historico = JSON.parse(localStorage.getItem('patio_historico')) || [];
        let config = JSON.parse(localStorage.getItem('patio_config')) || { nome: "P√ÅTIO PRO ELITE" };
        let ultimaFotoBase64 = null;
        const SENHA_MESTRA = "0907";

        document.getElementById('input-data-entrada').value = new Date().toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});

        // TRATAMENTO DE IMAGEM
        async function mostrarPrevia(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxW = 500;
                        canvas.width = maxW;
                        canvas.height = img.height * (maxW / img.width);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        ultimaFotoBase64 = canvas.toDataURL('image/jpeg', 0.6);
                        document.getElementById('img-previa').src = ultimaFotoBase64;
                        document.getElementById('container-previa').classList.remove('hidden');
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // LICEN√áA E ACESSO
        function verificarLicenca() {
            let dataAtivacao = localStorage.getItem('data_ativacao') || Date.now();
            if (!localStorage.getItem('data_ativacao')) localStorage.setItem('data_ativacao', dataAtivacao);
            const trintaDias = 30 * 24 * 60 * 60 * 1000;
            const decorrido = Date.now() - parseInt(dataAtivacao);
            const dias = Math.max(0, Math.ceil((trintaDias - decorrido) / (1000 * 60 * 60 * 24)));
            document.getElementById('dias-restantes').innerText = dias + " DIAS RESTANTES";
            document.getElementById('bloqueio').style.display = decorrido > trintaDias ? 'flex' : 'none';
        }

        function verificarSenha() {
            if (document.getElementById('senha-licenca').value === SENHA_MESTRA) {
                localStorage.setItem('data_ativacao', Date.now());
                location.reload();
            } else { alert("Senha incorreta"); }
        }

        // SALVAR ENTRADA
        document.getElementById('form-entrada').addEventListener('submit', (e) => {
            e.preventDefault();
            const novoVeiculo = {
                id: Date.now(),
                placa: document.getElementById('placa').value.toUpperCase(),
                modelo: document.getElementById('modelo').value.toUpperCase(),
                cliente: document.getElementById('cliente').value.toUpperCase(),
                telefone: document.getElementById('telefone').value,
                foto: ultimaFotoBase64,
                entrada: document.getElementById('input-data-entrada').value
            };
            patio.unshift(novoVeiculo);
            localStorage.setItem('patio_data', JSON.stringify(patio));
            alert("Ve√≠culo Registrado no P√°tio!");
            location.reload();
        });

        // MODAL DE SA√çDA
        window.abrirModalSaida = (id) => {
            document.getElementById('saida-id-temp').value = id;
            document.getElementById('input-data-saida').value = new Date().toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
            document.getElementById('modal-saida').style.display = 'flex';
        };

        window.fecharModalSaida = () => document.getElementById('modal-saida').style.display = 'none';

        // --- FUN√á√ÉO CR√çTICA: ENVIO PARA N8N ---
        window.confirmarSaidaFinal = async () => {
            const id = document.getElementById('saida-id-temp').value;
            const v = patio.find(item => item.id == id);
            const servico = document.getElementById('input-servico-final').value.toUpperCase() || "FINALIZADO";
            const btn = document.getElementById('btn-confirmar-saida');

            const pacoteParaN8N = {
                ...v,
                saida: document.getElementById('input-data-saida').value,
                servico_final: servico,
                timestamp_envio: new Date().toISOString()
            };

            // URL DE TESTE ATUALIZADA
            const URL_N8N = "https://n8n-projeto-n8n.bi9xft.easypanel.host/webhook-test/APKFUMA";

            try {
                btn.innerText = "ENVIANDO TESTE...";
                btn.disabled = true;

                // Disparo para o Webhook
                const response = await fetch(URL_N8N, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pacoteParaN8N)
                });

                if(response.ok) {
                    historico.unshift(pacoteParaN8N);
                    localStorage.setItem('patio_historico', JSON.stringify(historico));
                    patio = patio.filter(item => item.id != id);
                    localStorage.setItem('patio_data', JSON.stringify(patio));
                    
                    alert("Dados enviados ao n8n com sucesso!");
                    location.reload();
                } else {
                    throw new Error("Erro no servidor n8n");
                }

            } catch (error) {
                console.error("Erro:", error);
                alert("Falha no envio. Verifique se o n8n est√° em modo 'Listen'.");
                btn.innerText = "Concluir Teste";
                btn.disabled = false;
            }
        };

        // RENDERIZA√á√ÉO DE LISTAS
        function renderizarListas() {
            const containerPatio = document.getElementById('lista-veiculos');
            containerPatio.innerHTML = '';
            document.getElementById('contador').innerText = patio.length + " VE√çCULOS";
            
            patio.forEach(v => {
                containerPatio.innerHTML += `
                    <div class="bg-white p-4 rounded-3xl shadow-sm border border-gray-100 flex gap-4 items-center">
                        <img src="${v.foto || ''}" class="w-16 h-16 rounded-2xl object-cover bg-gray-50 flex-shrink-0">
                        <div class="flex-1 overflow-hidden">
                            <div class="font-black text-lg text-gray-800">${v.placa}</div>
                            <div class="text-[10px] text-blue-600 font-bold uppercase truncate">${v.modelo}</div>
                            <button onclick="abrirModalSaida(${v.id})" class="mt-2 w-full text-[8px] font-black bg-green-600 text-white p-2 rounded-lg uppercase">Finalizar Sa√≠da</button>
                        </div>
                    </div>`;
            });

            const containerRelatorio = document.getElementById('lista-relatorio');
            containerRelatorio.innerHTML = '';
            historico.forEach(v => {
                containerRelatorio.innerHTML += `
                    <div onclick="abrirDetalhes(${v.id})" class="bg-white p-4 rounded-3xl border border-gray-100 flex gap-4 items-center shadow-sm">
                        <img src="${v.foto || ''}" class="w-14 h-14 rounded-xl object-cover flex-shrink-0">
                        <div class="flex-1">
                            <div class="font-black text-sm uppercase">${v.placa}</div>
                            <p class="text-[9px] text-green-600 font-bold uppercase mt-1">‚úì ${v.servico_final}</p>
                            <p class="text-[8px] text-gray-400 font-bold uppercase mt-1">S: ${v.saida}</p>
                        </div>
                    </div>`;
            });
        }

        window.abrirDetalhes = (id) => {
            const v = historico.find(item => item.id == id);
            document.getElementById('detalhe-foto').src = v.foto || '';
            document.getElementById('detalhe-placa').innerText = v.placa;
            document.getElementById('detalhe-cliente').innerText = v.cliente;
            document.getElementById('detalhe-telefone').innerText = v.telefone;
            document.getElementById('detalhe-modelo').innerText = v.modelo;
            document.getElementById('detalhe-entrada').innerText = v.entrada;
            document.getElementById('detalhe-saida').innerText = v.saida;
            document.getElementById('detalhe-servico').innerText = v.servico_final;
            document.getElementById('pagina-detalhes').style.display = 'flex';
        };

        window.fecharDetalhes = () => document.getElementById('pagina-detalhes').style.display = 'none';

        window.mudarAba = (aba) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            document.getElementById('aba-' + aba).classList.add('active');
            document.getElementById('btn-nav-' + aba).classList.add('active');
        };

        // INICIALIZA√á√ÉO
        verificarLicenca();
        renderizarListas();
        document.getElementById('app-nome-display').innerText = config.nome;
    </script>
</body>
</html>
